# Project TODO

## 一、提示词配置页面重构（独立Tab页 + 卡片套卡片）

### 1.1 新增底部Tab页

- [x] 在 `app/(tabs)/_layout.tsx` 中新增「提示词」Tab页
- [x] 创建 `app/(tabs)/prompts.tsx` 作为提示词配置主页面
- [x] 从 `settings.tsx` 中移除提示词配置入口（原来的"管理提示词与预设"链接）
- [x] 删除或废弃 `app/prompt-settings.tsx`（原独立Modal页面）

### 1.2 配置卡片列表（外层卡片）

- [x] 顶部显示当前激活的配置名称和激活状态徽章
- [x] 以卡片列表展示所有配置预设（默认 + 用户创建）
- [x] 每张卡片显示：名称、描述、缩略图、是否激活（高亮标记）
- [x] 点击卡片进入该配置的详情页（内层小卡片）
- [x] 长按卡片可编辑名称/描述/图片
- [x] 提供「新建配置」按钮（右上角或底部FAB）
- [x] 激活逻辑：点击卡片右上角"激活"按钮切换，不可取消激活只能切换到其他配置
- [x] 默认配置（"默认"）始终存在且初始激活

### 1.3 配置详情页（内层小卡片）

- [x] 进入某个配置后，以小卡片形式展示该配置下的6个提示词
- [x] 每张小卡片显示：提示词名称、简短描述、内容预览
- [x] 点击小卡片弹出编辑Modal，可修改提示词内容
- [x] 提供「恢复此项默认值」和「恢复所有默认值」按钮
- [x] 保存修改时自动更新到对应预设

---

## 二、剧情总结增强（标题 + 参与人物）

### 2.1 数据结构修改

- [x] `StorySummaryRecord` 新增 `title: string` 字段（剧情总结标题）
- [x] `StorySummaryRecord` 新增 `involvedCharacters: string[]` 字段（参与人物名称列表）
- [x] 在 `story-store.ts` 中更新接口定义

### 2.2 AI提示词修改

- [x] 修改 `SUMMARY_SYSTEM_PROMPT`，要求AI输出JSON格式：
  ```json
  {
    "title": "剧情总结标题（10字以内）",
    "summary": "总结正文（200字以内）",
    "involvedCharacters": ["人物名1", "人物名2"]
  }
  ```
- [x] 修改 `llm-client.ts` 中 `summarizeStory` 的返回值解析逻辑

### 2.3 UI展示修改

- [x] 故事总结历史Modal中，每条总结显示标题、参与人物标签、正文
- [x] 总结卡片样式优化：标题加粗、人物以小标签/chip形式展示

---

## 三、角色卡片增强（外貌 + 已参与事件 + 人物形象图）

### 3.1 数据结构修改

- [x] `CharacterCard` 新增 `appearance: string` 字段（外貌描述）
- [x] `CharacterCard` 新增 `portraitUri?: string` 字段（人物形象图URI）
- [x] 更新 `story-store.ts` 接口定义和迁移逻辑

### 3.2 AI提示词修改

- [x] 修改 `STORY_SYSTEM_PROMPT` 和 `CONTINUE_SYSTEM_PROMPT` 中 `newCharacters` 格式：
  - 新增 `appearance` 字段要求（外貌描述：发色、瞳色、体型、服饰等，至少30字）
- [x] 修改 `buildCharacterCardsContext` 将外貌信息纳入上下文

### 3.3 角色卡片UI增强

- [x] 卡片显示区域新增「外貌」字段
- [x] 卡片新增「已参与事件」区域：遍历 `summaryHistory`，如果某条总结的 `involvedCharacters` 包含该角色名，则显示该总结的标题
- [x] 编辑模式新增外貌编辑框

### 3.4 人物形象图生成

- [x] 在角色卡片上添加"生成形象"按钮
- [x] 点击后：
  1. 由LLM根据角色的 name/gender/appearance/personality/background 生成详细的英文图片提示词
  2. 调用图片生成API生成人物形象图
  3. 将生成的图片URI存入 `characterCard.portraitUri`
- [x] 在 `llm-client.ts` 新增 `generateCharacterPortraitPrompt()` 函数
- [x] 在 `llm-prompts.ts` 新增 `CHARACTER_PORTRAIT_PROMPT` 系统提示词
- [x] 卡片顶部显示已生成的人物形象（圆形或方形头像）
- [x] 生成中显示loading状态，失败显示重试按钮

---

## 四、提示词Store适配

### 4.1 prompt-store适配

- [x] 确保 `CHARACTER_PORTRAIT_PROMPT` 被纳入可配置提示词列表
- [x] 在 `PROMPT_KEYS` 和 `PROMPT_META` 中添加新的提示词key
- [x] 默认预设中包含新提示词的默认值

---

## 五、测试与收尾

### 5.1 功能验证

- [ ] 验证新Tab页导航正常
- [ ] 验证配置切换逻辑（激活/新建/编辑）
- [ ] 验证剧情总结新格式（标题+人物）
- [ ] 验证角色卡片新字段显示
- [ ] 验证人物形象图生成流程
- [ ] 验证数据迁移兼容性（旧数据不报错）

---

## 六、本轮修复：历史记录定位 + 长上下文卡死

### 6.1 ToDoList（按步骤执行）

- [x] 分析历史弹窗滚动逻辑，确保打开时定位到最新剧情（底部）
- [x] 调整历史列表渲染顺序/初始滚动，使最新记录出现在页面底部
- [x] 增加上下文长度保护，避免长剧情导致 LLM 调用卡住或失败
- [x] 增加兜底分支：当 AI 未返回 choice 片段时自动补齐可继续选项
- [x] 运行测试并完成自检

---

## 七、本轮修复：总结触发与生图输入源

### 7.1 ToDoList（按步骤执行）

- [x] 将剧情总结触发条件改为：上下文达到 8000 字符（将被截断）时触发
- [x] 移除“每 5 次选择总结”的旧逻辑，改为按上下文长度动态触发
- [x] 确保每次继续生成剧情时都把已有总结作为前情提要送入 AI
- [x] 将生图提示词输入改为“当前剧情批次”（初次生成 / 每次选择后新返回剧情）
- [x] 运行测试并完成自检

---

## 八、本轮优化：上下文监控仪表盘（Debug）

### 8.1 ToDoList（按步骤执行）

- [x] 新增 ContextMonitor 调试组件（悬浮显示）
- [x] 接入上下文长度、截断状态、最近发送长度等实时指标
- [x] 增加历史上下文停滞检测（辅助排查“死循环”风险）
- [x] 将组件挂载到 game 页面（仅开发环境显示）
- [x] 运行测试并完成自检

---

## 九、本轮修复：提示词页可用性

### 9.1 ToDoList（按步骤执行）

- [x] 修复提示词 Tab 底栏图标不显示问题
- [x] 修复提示词详情页返回入口不明显/不可见问题
- [x] 增加显式“编辑配置”入口（不再依赖长按）
- [x] 确保新建配置可自定义名称、描述并插入图片（含默认配置改造分支）
- [x] 运行测试并完成自检

---

## 十、本轮优化：Debug监控点按住显示

### 10.1 ToDoList（按步骤执行）

- [x] 将大面板改为左上角小状态点
- [x] 实现按住显示详情、松开隐藏
- [x] 保留原有监控指标并压缩面板尺寸
- [x] 运行测试并完成自检

---

## 十一、本轮修复：防误触 + 记忆监控纠偏

### 11.1 ToDoList（按步骤执行）

- [x] 为剧情选项增加确认提示，降低快速连点误触
- [x] 修复“总结触发阈值”判断依据，改为基于全量剧情上下文字符数
- [x] 在 Debug 监控中增加“全量剧情字符数”显示，区分压缩发送与完整历史
- [x] 运行测试并完成自检

---

## 十二、本轮改造：每次总结 + 急缓节奏

### 12.1 ToDoList（按步骤执行）

- [x] 将剧情总结改为每次做选择后都生成（并保留标题/参与角色）
- [x] 引入剧情急缓等级（慵懒/轻松/紧张/紧迫）并纳入生成协议
- [x] 按急缓等级绑定本轮剧情字符下限（3000/2000/1500/1000）
- [x] 在 Debug 监控显示当前急缓等级与字数下限达成情况
- [x] 运行测试并完成自检

---

## 十三、本轮改造：角色沉浸与关系系统

### 13.1 ToDoList（按步骤执行）

- [x] 梳理并扩展数据模型：主角立绘、角色好感度、可见性分级字段迁移
- [x] 修复历史记录：明确记录并展示玩家每次选择
- [x] 调整 Debug 监控点位置到左侧中段，避免遮挡返回按钮
- [x] 重做选择确认 UI（自定义弹层，风格与现有面板统一）
- [x] 对话区角色名旁显示立绘（含主角）
- [x] 角色卡片加入主角卡，并支持主角/NPC生成形象
- [x] 实现好感度规则：初始值保守、仅在明显帮助/契合性格时小幅增长
- [x] 性格/背景默认隐藏并按 25/50/75/100 四级解锁展示
- [x] 好感度联动判定值：高好感角色相关选项判定值下调
- [x] 回归验证（类型检查/测试）并逐项确认“标题+参与事件”功能仍可用

---

## 十四、本轮修复：初始节奏可选 + 字数判定 + 角色头像点击

### 14.1 ToDoList（按步骤执行）

- [x] 在创建故事页增加“初始剧情节奏”选项（默认轻松），并落库存档
- [x] 将初始/续写请求中的节奏约束改为强约束，修复始终按 1000 字判定的问题
- [x] 提示词与用户请求补充硬性规则：按指定节奏生成，字符数不得低于对应目标
- [x] 字数校验增加 10% 宽松阈值（如慵懒 3000 时 2700 即通过）并优化报错文案
- [x] 修复角色卡片头像点击误触生成：点击头像改为放大预览，生成仅由按钮触发
- [x] 运行测试并完成自检

---

## 十五、本轮修复：自定义选项丢失 + 历史顺序 + 总结标题重复

### 15.1 ToDoList（按步骤执行）

- [x] 修复自定义选项在兜底分支中丢失问题，保留玩家刚输入行动
- [x] 调整历史记录展示顺序：最新在上、最旧在下，去掉强制滚动到底
- [x] 强化总结提示词：标题必须体现“本段新增事件/变化”，禁止与近期标题重复
- [x] 总结调用增加近期标题上下文，降低重复标题概率
- [x] 运行测试并完成自检

---

## 十六、本轮修复：主角外貌 + 节奏判定链路

### 16.1 ToDoList（按步骤执行）

- [x] 为创建故事新增主角外貌字段，并持久化到存档
- [x] 支持主角外貌单独随机生成（不影响其他字段）
- [x] 将主角外貌接入剧情生成上下文（初始/续写）
- [x] 修复节奏强校验导致的卡死：本轮按当前节奏验收，下轮按本轮 AI 输出节奏推进
- [x] 运行测试并完成自检

---

## 十七、本轮优化：推理向结构化生成约束

### 17.1 ToDoList（按步骤执行）

- [x] 将剧情生成规则升级为“结构验收清单”，弱化单纯字数驱动
- [x] 按急缓节奏加入分档结构配额（segments 数量、推进次数、后果强度）
- [x] 强化推理向权重（线索、矛盾点、可验证信息、误导与反转）
- [x] 增加输出前自检指令，要求不足时先补写再输出 JSON
- [x] 运行测试并完成自检

---

## 十八、本轮校准：节奏结构配额 + 选项策略分化 + 自检指令

### 18.1 ToDoList（按步骤执行）

- [x] 校对并强化四档节奏结构配额文案（12-16/10-14/9-12/8-10 + 推进/后果约束）
- [x] 落实选项质量约束：2-4 选项至少覆盖 3 个策略维度
- [x] 落实反作弊约束：选项必须为“动词 + 对象 + 方式/代价”
- [x] 落实统一自检语句：不足先补写再输出 JSON（不输出自检过程）
- [x] 运行测试并完成自检

---

## 十九、本轮部署：选项可见性 + 视觉优化 + 主角卡片布局

### 19.1 ToDoList（按步骤执行）

- [x] 调整自定义行动入口：置顶显示，并为选项区增加可滚动能力
- [x] 生图固定为 16:9 并让背景图铺满整页界面
- [x] 对话栏改为半透明，提升背景可见度
- [x] 对话人物头像尺寸放大两倍
- [x] 移除字符数硬验收（仅保留提示词约束）
- [x] 角色卡片：主角名后增加标识；主角头像+名字靠左，其他角色靠右
- [x] 运行测试并完成自检

---

## 二十、本轮修复：移除字数拦截残留感知 + 外貌随机并回故事随机

### 20.1 ToDoList（按步骤执行）

- [x] 复查并确认运行链路中不再触发“字数不足”硬拦截
- [x] 移除主角外貌“单独随机”入口与逻辑
- [x] 保留主角外貌随“故事随机”一起生成
- [x] 运行测试并完成自检

---

## 二十一、本轮修复：故事随机必带主角外貌

### 21.1 ToDoList（按步骤执行）

- [x] 修复随机设定返回缺失 protagonistAppearance 时的兜底逻辑
- [x] 确保创建页点击“随机”后主角外貌稳定被填充
- [x] 运行测试并完成自检
