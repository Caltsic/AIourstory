# AI Story Game 后端分离与社区功能实施计划

## 1. 项目目标

在现有 React Native + Expo 客户端基础上，新增可部署到阿里云 ECS（2C2G）的后端服务，支持：

1. 账号系统（匿名自动登录 + 可绑定用户名密码）。
2. 提示词广场（投稿、审核、浏览、点赞、下载计数）。
3. 故事广场（投稿、审核、浏览、点赞、下载计数）。
4. 独立 Web 管理后台（审核流程）。

## 2. 约束与原则

1. 服务器配置：Ubuntu 22.04，2C2G，40GB，按流量计费。
2. 成本优先：不上传图片，只传文本和结构化配置。
3. 现有游戏离线能力不能被破坏。
4. 后端要轻量、可维护、可逐步演进。

## 3. 账号方案选择

### 方案对比

1. 用户名+密码：实现简单，成本低，但注册摩擦较高。
2. 短信/邮箱验证码：体验好，但接入和运营成本持续增加。
3. OAuth（微信/GitHub）：接入复杂，受备案与平台资质影响。
4. 设备匿名账号 + 绑定账号：首次零摩擦，上传时再绑定，最适合游戏场景。

### 最终选择

采用 `设备匿名自动登录 + 用户名密码绑定（上传前必绑定）`。

### 行为规则

1. 首次进入应用：`device-login` 自动创建匿名账号。
2. 匿名用户可浏览/下载广场内容。
3. 匿名用户不可投稿、不可管理。
4. 投稿前必须绑定用户名密码（升级为 bound 账号）。

## 4. 后端技术栈

1. 运行时：Node.js 20 LTS。
2. 框架：Fastify。
3. 数据库：SQLite（libsql 驱动）+ WAL。
4. ORM：Drizzle ORM。
5. 认证：JWT（jose）+ refresh token 轮换。
6. 密码哈希：bcryptjs。
7. 反向代理：Caddy 或 Nginx（二选一，生产建议 Caddy 自动 HTTPS）。
8. 进程守护：PM2 + systemd。

## 5. 当前代码落地状态（已完成）

已在仓库新增 `server/` 子项目并通过 TypeScript 编译。

### 已落地模块

1. 基础服务入口与中间件。
2. 数据库 schema 与迁移生成能力。
3. 认证接口：设备登录、绑定注册、密码登录、刷新、登出、me。
4. 提示词广场接口：列表、详情、投稿、编辑、删除、点赞、下载、我的投稿。
5. 故事广场接口：列表、详情、投稿、编辑、删除、点赞、下载、我的投稿。
6. 管理审核接口：提示词/故事待审列表、通过、驳回。

### 已创建的关键文件

1. `server/src/index.ts`
2. `server/src/config.ts`
3. `server/src/db/schema.ts`
4. `server/src/db/index.ts`
5. `server/src/services/auth.service.ts`
6. `server/src/services/prompt.service.ts`
7. `server/src/services/story.service.ts`
8. `server/src/routes/auth.ts`
9. `server/src/routes/prompts.ts`
10. `server/src/routes/stories.ts`
11. `server/src/routes/admin.ts`
12. `server/src/db/migrations/0000_public_legion.sql`

## 6. 数据库模型设计

### users

1. 匿名与绑定统一在一张表。
2. 关键字段：`uuid/device_id/username/password_hash/is_bound/role`。

### prompt_presets

1. 保存广场提示词投稿。
2. `prompts_json` 保存 7 段提示词内容。
3. `status` 流程：`pending/approved/rejected`。

### story_settings

1. 保存故事设置投稿（不是完整游玩过程）。
2. 包含主角信息、难度、节奏、额外描述。
3. 同样使用审核状态流。

### likes / downloads / refresh_tokens

1. `likes`：点赞去重。
2. `downloads`：下载计数去重。
3. `refresh_tokens`：刷新令牌持久化与轮换。

## 7. API 结构

统一前缀：`/v1`

### auth

1. `POST /auth/device-login`
2. `POST /auth/register`
3. `POST /auth/login`
4. `POST /auth/refresh`
5. `POST /auth/logout`
6. `GET /auth/me`
7. `PUT /users/me`

### prompts

1. `GET /prompts`
2. `GET /prompts/:uuid`
3. `GET /prompts/mine`
4. `POST /prompts`
5. `PUT /prompts/:uuid`
6. `DELETE /prompts/:uuid`
7. `POST /prompts/:uuid/like`
8. `POST /prompts/:uuid/download`

### stories

1. `GET /stories`
2. `GET /stories/:uuid`
3. `GET /stories/mine`
4. `POST /stories`
5. `PUT /stories/:uuid`
6. `DELETE /stories/:uuid`
7. `POST /stories/:uuid/like`
8. `POST /stories/:uuid/download`

### admin

1. `GET /admin/review/prompts`
2. `GET /admin/review/stories`
3. `POST /admin/review/:type/:uuid/approve`
4. `POST /admin/review/:type/:uuid/reject`

## 8. 提示词广场设计

### 上传字段

1. `name`
2. `description`
3. `promptsJson`
4. `tags`

### 不上传字段

1. 本地图片 URI。
2. 客户端本地 ID。

### 审核流程

1. 用户提交 -> `pending`。
2. 管理员通过 -> `approved`。
3. 管理员驳回 -> `rejected + rejectReason`。

### UI 排布建议

1. 顶部：搜索 + 排序（最新/热门/下载）。
2. 中部：标签筛选。
3. 主体：卡片列表（名称、描述、作者、统计）。
4. 详情：展示 7 个提示词分段预览与一键使用。

## 9. 故事广场设计

### 上传字段

1. `title`
2. `premise`
3. `genre`
4. `protagonistName`
5. `protagonistDescription`
6. `protagonistAppearance`
7. `difficulty`
8. `initialPacing`
9. `extraDescription`
10. `tags`

### extraDescription 用途

1. 作者对玩法意图和推荐搭配的补充说明。
2. 用户在详情页快速判断是否适合自己。

### UI 排布建议

1. 顶部：搜索 + 排序 + 类型筛选。
2. 主体：故事卡片（标题、题材、前提摘要、作者、统计）。
3. 详情：完整故事设置 + 额外描述折叠区。
4. 行为：一键带入 create-story 表单。

## 10. 前端改造计划

### 导航与页面

1. 新增 `广场` Tab。
2. 广场内使用 segmented control 切换 `提示词广场`/`故事广场`。
3. 新增页面：详情页、投稿页、我的投稿、登录/绑定页。

### 状态管理

1. 新增 `auth-store` 或 `auth-provider`。
2. 安全存储 access token + refresh token。
3. API 客户端支持自动刷新 token。

### 离线策略

1. 游戏本体继续纯离线可用。
2. 广场页离线时提示网络不可用。
3. 已下载配置本地缓存可继续使用。

## 11. 管理后台方案

1. 独立轻量 Web 页面（可用原生 HTML + Alpine.js）。
2. 与 API 同机部署。
3. 只做审核工作流，不做复杂运营系统。
4. 页面功能：登录、待审列表、通过、驳回、搜索。

## 12. 部署架构

### 服务器进程

1. `Caddy/Nginx`：TLS 与反代。
2. `Node Fastify`：API 服务。
3. `SQLite`：本地文件库。
4. `PM2`：进程守护。

### 目录建议

1. `/opt/aistory/server`
2. `/opt/aistory/server/data`
3. `/opt/aistory/backups`
4. `/opt/aistory/logs`

### 部署顺序

1. 上传代码并安装依赖。
2. 配置 `.env`。
3. 运行 `pnpm run db:migrate`。
4. `pnpm run build`。
5. PM2 启动并设置开机自启。
6. 配置 Caddy 反向代理。

## 13. 备份与监控

1. SQLite 每日定时备份到本机 `backups`。
2. 可选同步 OSS（异地容灾）。
3. PM2 logrotate 控制日志体积。
4. 使用 `/health` 做存活检测。

## 14. ICP 与域名策略

1. 域名未备案期间：先用公网 IP + 端口联调。
2. 备案完成后：切域名 + HTTPS。
3. 建议上线前统一切到 `https://api.xxx.com/v1`。

## 15. 接下来执行清单

1. 前端接入认证与 API client。
2. 新建广场相关页面与交互。
3. 新建管理后台页面。
4. 编写基础联调脚本（注册、投稿、审核、下载链路）。
5. 完成 ECS 部署脚本与上线文档。

## 16. 设置页日志功能（本轮新增）

### 16.1 目标

1. 提供可视化日志查看能力，便于排查线上/真机问题。
2. 在不引入重依赖的前提下，完成本地日志采集、展示、清空与导出。

### 16.2 方案

1. 新增 `lib/app-logger.ts` 作为统一日志层：
   1. 支持 `info/warn/error` 分级。
   2. 自动持久化到 `AsyncStorage`（滚动保留最近 N 条）。
   3. 提供读取、清空、格式化导出能力。
2. 应用启动时在 `app/_layout.tsx` 初始化日志系统，接管 `console.log/warn/error`。
3. 在 `app/(tabs)/settings.tsx` 新增“日志”区域：
   1. 查看日志（Modal）。
   2. 清空日志（带确认）。
   3. 导出日志（系统分享面板）。

### 16.3 验收标准

1. 设置页可打开日志面板并看到最近日志。
2. 触发报错后能在日志中看到错误内容与时间戳。
3. 日志可一键清空并立即生效。
4. `pnpm run check` 通过。

## 17. BUG.md 问题修复（本轮新增）

### 17.1 目标

1. 修复“退出后仍然保持登录状态”问题。
2. 修复“故事广场投稿页进入后频闪卡死”问题。
3. 修复“APK 中调试仪表盘消失”问题（与 Expo Go 行为对齐）。

### 17.2 修复方案

1. 账号退出问题：
   1. 后端 `device-login` 若命中已绑定账号，不再直接返回该账号。
   2. 自动为该设备创建/切换到匿名账号，确保登出后一定回到匿名会话。
2. 投稿页频闪问题：
   1. `submit-story` 页面 `useEffect` 不再依赖 `params` 对象本身。
   2. 改为依赖稳定的具体参数字段，避免每次渲染重复触发初始化。
3. 仪表盘显示问题：
   1. `game` 页移除仅 `__DEV__` 显示限制，保持 APK 与 Expo Go 一致可见。

### 17.3 验收标准

1. 绑定账号点击退出后，立即变为匿名账号并且重启 App 仍保持匿名。
2. 进入“故事广场 -> 投稿”页面时不再出现闪烁/卡死。
3. APK 中可看到调试仪表盘（绿色点）。
4. `pnpm run check` 通过。

## 18. 安全防护升级（本轮新增）

### 18.1 目标

1. 降低开源项目被扫描后被直接打穿的风险。
2. 在不增加太多资源开销的前提下完成基础加固。
3. 明确一套可执行的服务器安全基线清单。

### 18.2 实施范围

1. 后端应用层：
   1. 启用安全响应头（Helmet）。
   2. 细化全局与敏感路由限流策略（登录/刷新/管理员审核）。
   3. 增加生产配置安全校验（JWT secret 最小长度等）。
2. 部署层文档：
   1. 新增 `SECURITY.md`，提供从“必须做”到“建议做”的分级清单。
   2. 给出 Nginx `/admin` 基础认证与速率限制模板。
3. 运维执行层：
   1. 密钥轮换。
   2. 防火墙与登录防护（UFW/Fail2ban）。
   3. 日志与备份检查清单。

### 18.3 验收标准

1. 后端编译通过，核心接口可正常访问。
2. 登录/管理员接口触发限流时返回 429。
3. 安全基线文档可直接按步骤执行。

## 19. 交互与生图链路修复（本轮新增）

### 19.1 目标

1. 修复“自定义行动缺失判定值”导致掷骰逻辑失真的问题。
2. 修复“随机主角外貌与题材错位”问题（如仙侠题材出现现代皮夹克）。
3. 修复“创建故事后未按开场自动触发背景生图，且角色图未进入队列”的链路问题。

### 19.2 实施方案

1. 自定义行动判定：
   1. `evaluateCustomAction` 改为始终返回 `1-8` 判定值，不再返回 `null`。
   2. 增加按难度的本地兜底判定值，避免模型异常时中断掷骰。
2. 主角外貌生成：
   1. 重构随机外貌兜底逻辑，按 `genre + personality + premise` 生成。
   2. 为不同题材建立服饰语义映射，避免题材错配。
3. 创建后生图链路：
   1. `create-story` 改为仅创建存档并进入 `game`，由 `game` 的初始化流程统一生成剧情与入队。
   2. 在初始生成后新增“开场上下文”背景生图入队（`initial-opening`），并保留角色立绘自动队列。

### 19.3 验收标准

1. 自定义行动（非“无随机”）必触发判定并出现掷骰流程。
2. 随机主角外貌与题材一致性明显提升（仙侠不再出现现代皮夹克等违和搭配）。
3. 创建故事后可看到背景图任务自动入队，新增角色立绘任务也会自动入队。

## 20. 续写链路并行化与长历史压缩（本轮新增）

### 20.1 目标

1. 降低“继续剧情”单次串行请求数量，缩短用户等待时长。
2. 续写请求优先直发上下文，不再被摘要刷新阻塞。
3. 当剧情总长超过 8000 字时，自动并行执行摘要压缩并回写历史。
4. 生成新摘要后，自动调用 LLM 生成简短标题，保持角色事件标签可读。
5. 调整节奏字符目标：慵懒1600、轻松1200、紧张900、紧迫600。

### 20.2 实施方案

1. `continue` 主链路：
   1. 用户选择后立即调用 `continueStory`，上文使用当前完整历史文本。
   2. 将摘要刷新从前置串行改为后台并行任务，不阻塞续写返回。
2. 长历史压缩：
   1. 设定压缩阈值为 8000 字。
   2. 摘要完成后将“已覆盖历史段”折叠为单条摘要叙述段，保留之后新增段落。
   3. 维持 `summaryHistory` 记录，避免角色“已参与事件”能力退化。
3. 摘要标题：
   1. 检测到新摘要时调用单独标题生成接口（短标题，去重）。
   2. 标题失败时使用摘要文本兜底截断。
4. 节奏目标：
   1. 下调 `PACE_MIN_CHARS` 映射以提升响应速度并降低超时概率。

### 20.3 验收标准

1. 选择后“继续剧情”只阻塞续写请求本身，不再等待摘要调用。
2. 历史超过 8000 字后，后台可完成摘要压缩并自动更新上下文。
3. 新摘要记录包含可读短标题，角色事件列表继续可用。
4. `pnpm run check` 与 `pnpm test` 通过。

## 21. 角色好感度可感知与结算增强（本轮新增）

### 21.1 目标

1. 解决“好感度几乎看不到变化”的体感问题。
2. 支持负向选择降低好感度，并与掷骰结果联动。
3. 保持现有角色事件链与存档结构不破坏。

### 21.2 实施方案

1. 结算逻辑升级：
   1. 重构 `applyAffinityFromChoice`，返回结构化变化结果（角色、前后值、增减值、来源）。
   2. 正负关键词双向识别，允许负向降好感。
2. 关联策略增强：
   1. 优先匹配选项文本显式提及角色。
   2. 其次匹配最近对话角色。
   3. 再次匹配最近摘要涉及角色（弱关联）。
3. 掷骰联动：
   1. `better/exact/worse` 对变化幅度做加权。
   2. 单角色单回合变化限制在 `[-3, +3]`。
4. 可见反馈与调试：
   1. 选择后展示短时“好感变化”提示条。
   2. Debug Context 增加最近一次好感结算摘要。

### 21.3 验收标准

1. 正向选择可触发相关角色好感上升。
2. 负向选择可触发相关角色好感下降。
3. 掷骰结果会影响单次好感变化幅度。
4. 角色“已参与事件”与现有功能不受影响。

## 22. IP 直连联调默认配置修复（本轮新增）

### 22.1 目标

1. 在服务器备案未完成前，确保 APK 默认可通过 IP 直连后端。
2. 避免默认 HTTPS+IP 导致 TLS 失败触发 `AxiosError: Network Error`。
3. 降低联调门槛，减少每次构建依赖环境变量的配置风险。

### 22.2 实施方案

1. 客户端 API 默认地址：
   1. 将默认 `EXPO_PUBLIC_API_BASE_URL` 回退值改为 `http://8.137.71.118:3000/v1`。
2. Android 清流量策略：
   1. 在 `app.config.ts` 根据默认 API 地址自动判断是否需要启用 `usesCleartextTraffic`。
   2. 对 IP 直连与本地联调地址自动放行，保留环境变量显式覆盖能力。

### 22.3 验收标准

1. 未设置环境变量时，应用默认走 `http://8.137.71.118:3000/v1`。
2. Android 构建产物在 IP 直连场景下可发起 HTTP 请求，不再被清流量策略拦截。
3. `pnpm run check` 通过。

## 23. DashScope 生图 404 兼容修复（本轮新增）

### 23.1 目标

1. 修复 DashScope 在图片生成场景下持续返回 404 的问题。
2. 在不影响现有 OpenAI 兼容生图服务的前提下，增加 DashScope 端点兼容。
3. 支持 DashScope 异步任务结果轮询，避免仅返回 task_id 时失败。

### 23.2 实施方案

1. 在 `image-client` 中引入 DashScope 识别与端点候选策略：
   1. 先尝试现有 OpenAI `images/generations`。
   2. 若命中 DashScope，再尝试其原生图像接口。
2. 新增 DashScope 返回解析：
   1. 支持 `output.results[].url` 直接返回。
   2. 支持 `task_id` 轮询 `/api/v1/tasks/{task_id}` 直到完成。
3. 保留当前尺寸与错误处理逻辑，确保兼容已有生图提供商。

### 23.3 验收标准

1. DashScope 配置下不再因端点不匹配直接 404。
2. DashScope 返回异步任务时，客户端能自动轮询并拿到图片地址。
3. 既有 OpenAI 兼容生图流程行为保持不变。

## 24. 图片配置主流厂商预设（本轮新增）

### 24.1 目标

1. 在图片配置中提供主流厂商一键预设，降低手动配置成本。
2. 覆盖火山、千问、千帆、Grok 四类常用提供商。
3. 保留自定义编辑能力，并给 DashScope 异步模型提供使用提示。

### 24.2 实施方案

1. 在 `settings` 页面新增图片预设数据源：
   1. 预置厂商名、API URL、推荐模型（可编辑）。
   2. 增加“自定义”占位项。
2. 图片配置 UI 新增预设选择卡片与弹窗：
   1. 交互与文本模型预设一致。
   2. 选择预设后回填图片 URL/模型。
3. DashScope 预设补充说明文案：
   1. 提示 `qwen-image` 可同步/异步。
   2. 提示万相模型为异步，应用会自动轮询任务。

### 24.3 验收标准

1. 用户可在图片配置中选择火山、千问、千帆、Grok 预设。
2. 预设选择后可自动回填 URL/模型，并允许手动覆盖。
3. `pnpm run check` 通过。

## 25. 生图日志可观测与温度可配置（本轮新增）

### 25.1 目标

1. 修复“图片生成失败时日志信息不足”导致排障困难的问题。
2. 为语言模型增加温度可配置项，兼容 KIMI 等对温度参数敏感的厂商。
3. 维持现有调用链路兼容，不破坏历史配置。

### 25.2 实施方案

1. 生图日志增强：
   1. 在 `image-client` 记录请求候选端点、状态码与错误摘要。
   2. 在任务轮询失败与最终失败时写入结构化日志。
2. 温度配置持久化：
   1. `storage` 新增 `temperature` 字段读写，默认值 `0.7`。
   2. 清理配置时同步删除温度字段。
3. 温度设置入口：
   1. 设置页 AI 配置增加温度输入框（0-2）。
   2. 保存与测试连接时做范围校验并传入请求。
4. LLM 调用接入：
   1. 统一从配置读取温度并应用到主要文本请求。

### 25.3 验收标准

1. 图片生成失败时，日志中可见候选端点、状态码和错误摘要。
2. 用户可在设置中保存并测试温度参数。
3. LLM 请求使用用户配置温度。
4. `pnpm run check` 通过。

## 26. Grok 生图 size 参数兼容修复（本轮新增）

### 26.1 目标

1. 修复 Grok 图像模型返回 `Argument not supported: size` 的调用失败问题。
2. 保持其他生图提供商（需要 size 的模型）兼容。

### 26.2 实施方案

1. 在生图请求失败分支识别 size 参数不支持错误。
2. 命中后自动移除 `size` / `image_size` 并重试一次同端点请求。
3. 为该重试路径补充日志，便于后续排障。

### 26.3 验收标准

1. Grok 图像模型在 size 参数不支持场景可自动降级重试。
2. 非该类错误不触发无关重试，维持现有错误语义。
3. `pnpm run check` 通过。

## 27. 图片 size 传参策略回归修复（本轮新增）

### 27.1 目标

1. 恢复“未填写 size 时不传 size 参数”的既定规则。
2. 修复 Grok `Argument not supported: size` 未命中降级重试的问题。
3. 保持已有 DashScope 与 OpenAI 兼容逻辑稳定。

### 27.2 实施方案

1. 在 `image-client` 中仅当用户显式填写且格式合法时才附带 `size` / `image_size`。
2. DashScope 原生请求仅在有 size 时才附带 `parameters.size`。
3. 调整失败分支优先级：先匹配“size 不支持”再匹配“size 像素不足”重试。
4. 保留“去掉 size 重试一次”的兜底，并补充日志。

### 27.3 验收标准

1. 未填写 size 时，请求体不包含任何 size 字段。
2. Grok 返回 `Argument not supported: size` 时可自动去参重试。
3. `pnpm run check` 通过。

## 28. 互动即结算的好感度重构（本轮新增）

### 28.1 目标

1. 解决“好感度始终无变化”的体验问题。
2. 规则调整为：只要存在角色互动，完成该段剧情时就产生好感变化。
3. 按难度分层：低难度高增低减，高难度低增高减。

### 28.2 实施方案

1. 好感结算触发：
   1. 取消“必须命中正负关键词才结算”的硬条件。
   2. 只要匹配到互动角色（点名/近期对话/摘要）就结算。
2. 方向判定：
   1. 优先依据正负关键词。
   2. 中性文本按掷骰结果兜底（`worse` 倾向负向，其余倾向正向）。
3. 难度幅度表：
   1. 简单：`+10/+12`，`-1/-2`。
   2. 普通：中间档位平滑过渡。
   3. 困难/噩梦：增幅继续降低，减幅继续提高（噩梦接近 `+1/+2`，`-8/-10`）。

### 28.3 验收标准

1. 有互动时本段结算后必有好感变化。
2. 低难度更容易涨、难度越高越容易跌。
3. `pnpm run check` 通过。

## 29. 历史压缩可见性与角色名显示修复（本轮新增）

### 29.1 目标

1. 修复“历史压缩摘要段直接出现在剧情里”导致卡顿与自动推进失效的问题。
2. 保持历史压缩仅用于 AI 上下文与总结存储，不在可见剧情中展示。
3. 修复角色已知名后，剧情对话区仍显示旧称呼的问题。

### 29.2 实施方案

1. 历史压缩回写：
   1. 取消向 `segments` 注入 `[历史压缩摘要]` 旁白段。
   2. 压缩时只保留尾部未压缩段，并维护 `storySummary/summaryHistory`。
2. 角色名显示：
   1. 对话区角色名从“段落原始字符”改为“角色卡映射显示名”。
   2. 当角色卡 `isNameRevealed` 变为 true 后，旧段落也显示真名。

### 29.3 验收标准

1. 历史压缩后，玩家界面不再出现大段 `[历史压缩摘要]` 文本。
2. 自动推进不再被摘要段卡住。
3. 角色知晓真名后，对话区显示名会同步切换。

## 30. 输入体验与真名自动揭示优化（待确认后实施）

### 30.1 目标

1. 修复“创建故事-故事开场输入时被输入法遮挡”的问题。
2. 修复“自定义选项输入框关闭后草稿丢失”的问题。
3. 增加“角色真名稳定出现后自动揭示”逻辑，降低对 `knownToPlayer` 的单点依赖。

### 30.2 实施方案

1. 创建故事输入遮挡优化：
   1. 在 `create-story` 页面接入 `KeyboardAvoidingView` + `ScrollView` 键盘联动策略。
   2. 对多行“故事开场”输入框增加焦点滚动到可见区域（iOS/Android 分别校准）。
2. 自定义输入草稿保留：
   1. 自定义选项文本改为独立草稿状态，不在关闭弹窗时清空。
   2. 仅在“提交成功”或“手动清空”时重置草稿。
3. 真名自动揭示：
   1. 增加“真名稳定出现计数器”（按角色卡维度，基于最近对话段）。
   2. 同一真名在连续/近期对话中达到阈值（如 2~3 次）时，自动将 `isNameRevealed` 置为 `true`。
   3. 自动揭示后同步刷新对话区显示名与角色卡展示。

### 30.3 验收标准

1. 创建故事输入“故事开场”时，输入框不再被键盘遮挡。
2. 自定义输入弹窗关闭再打开后，未提交草稿仍在。
3. 角色真名在剧情中稳定出现后，会自动从别名切换到真名展示。
4. `pnpm run check` 通过。

## 31. AI 驱动的初始好感度评估（本轮新增）

### 31.1 目标

1. 修复“新角色初始好感度几乎都为 0”导致关系不真实的问题。
2. 让 AI 基于剧情关系判断初始好感（亲属/师徒/同伴/敌对等）。
3. 保留本地规则兜底，避免 AI 失败时完全无分配。

### 31.2 实施方案

1. 在 `llm-client` 新增“初始好感评估”接口：
   1. 输入主角信息、故事背景、角色画像。
   2. 输出角色名到好感值（0-100）的 JSON 映射。
2. 在 `game` 的新角色入场链路接入：
   1. 先用本地规则给出兜底初值。
   2. 再调用 AI 批量覆盖新角色初始好感。
3. 增加失败降级：
   1. AI 调用异常时保留兜底值并记录 warn 日志。

### 31.3 验收标准

1. 新角色入场后，初始好感能体现与主角关系，不再普遍为 0。
2. AI 调用失败时不影响主流程，仍有可用兜底值。
3. `pnpm run check` 通过。

## 32. 配置编辑适配、主角性别、URL 手动填写与全链路日志（本轮新增）

### 32.1 目标

1. 修复提示词/预设编辑弹窗被顶部区域遮挡、键盘遮挡输入的问题。
2. 补齐主角性别参数并透传到 LLM 上下文。
3. 取消自动补全 `/chat/completions` 与 `/images/generations`，允许用户填写任意厂商 endpoint。
4. 将每次 LLM/生图请求与响应写入本地日志，便于排查格式/兼容性问题。
5. 统一系统提示词中的节奏字符下限，与 `PACE_MIN_CHARS` 一致。

### 32.2 实施方案

1. 编辑弹窗适配：
   1. 提示词编辑 Modal 统一包裹 `ScreenContainer(edges=top/bottom/left/right)`。
   2. 增加 `KeyboardAvoidingView`，确保取消/保存与输入区不被遮挡。
   3. 预设编辑弹窗同样增加键盘避让。
2. 主角性别：
   1. `Story` 增加 `protagonistGender`，并在迁移中默认补为“未知”。
   2. 创建页新增性别选项（含自定义）。
   3. 生成/续写/关系评估调用将性别作为主角上下文注入。
3. URL 手动填写：
   1. LLM 与图片生成请求完全使用用户填写的 URL，不再拼接固定路径。
   2. 设置页增加提示文案，提醒填写完整 endpoint。
4. 全链路日志：
   1. LLM 侧记录请求 messages 摘要与响应 content 摘要（均截断）。
   2. 生图侧记录请求 prompt 摘要、候选端点与响应信息。
5. 节奏下限统一：
   1. 更新 `llm-prompts` 中的节奏字符下限为 1600/1200/900/600。

### 32.3 验收标准

1. 编辑弹窗不再被顶部遮挡，键盘弹起时可正常编辑与保存。
2. 主角性别在创建页可配置，且进入生成请求上下文。
3. 任意自定义 endpoint URL 可直接填写并生效。
4. 日志可查看每次请求与响应摘要。
5. `pnpm run check` 通过。

## 33. 剧情生成跨页面不串 UI（最小改动）（本轮新增）

### 33.1 目标

1. 修复“生成中返回主页面/切换其他故事后，生成完成会污染当前故事 UI”的问题。
2. 让生成任务即使不在当前剧情页也能写回对应存档，不弹错页弹窗、不打断其他故事。
3. 主页面可显示每个故事的生成状态与最后一次失败原因。

### 33.2 实施方案

1. UI 守卫（request token + storyId）：
   1. 为每次初始生成/续写生成唯一 token，并绑定启动时的 storyId。
   2. 所有 UI 更新（setStory/setViewIndex/setGenerating/Alert）必须通过守卫校验：仅当当前页面仍处于该 storyId 且 token 为最新才允许更新。
   3. 存档写入（updateStory）不受守卫影响，确保结果写回正确故事。
2. Story 状态字段：
   1. 在存档中增加 `storyGenerationStatus`（idle/generating/failed）与 `lastStoryGenerationError`（仅保留最后一次）。
   2. 生成开始写入 generating，成功回 idle，失败写 failed + error。
3. 主页面展示：
   1. 故事卡片展示 generating/failed 状态与失败原因摘要。
   2. 不弹阻断式弹窗，避免在“错误页”干扰用户。

### 33.3 验收标准

1. 故事 A 生成中返回主页面并进入故事 B，故事 A 完成后不会覆盖故事 B 的 UI。
2. 故事 A 生成失败不会在故事 B 弹窗提示。
3. 主页面能显示每个故事的生成状态与最后一次失败原因（仅最后一次）。
4. `pnpm run check` 与 `pnpm test` 通过。

## 34. 剧情续写超时阈值调整（本轮新增）

### 34.1 目标

1. 对部分生成较慢的模型，提高“继续剧情”请求超时阈值，降低误判超时。

### 34.2 实施方案

1. 将 `continueStory` 的 Abort 超时从 90 秒调整为 300 秒。
2. 保持日志输出包含 timeoutMs，便于排障。

### 34.3 验收标准

1. 慢模型在 90-300 秒区间不再被提前 Abort。
2. `pnpm run check` 通过。

## 35. 摘要压缩并发回档修复（本轮新增）

### 35.1 目标

1. 修复“摘要压缩与续写并发导致 segments 清空、UI 卡死、重进回到开头”的恶性问题。
2. 摘要仅作为 AI 上文与总结记录，不影响可见剧情段。
3. 续写上文使用“摘要 + 最近剧情(25段)”结构，避免用摘要替代剧情段。
4. 已受损存档（segments为空但有摘要）自动从摘要恢复续写。

### 35.2 实施方案

1. 摘要回写：
   1. `applySummaryCompressionTask` 仅更新 `storySummary/summaryHistory`，不再裁剪 `segments`。
   2. 摘要写入使用最新存档合并，避免覆盖并发续写结果。
2. 续写上下文：
   1. `continueStory.history` 改为 `buildHistoryContext(segments, storySummary)`。
   2. 将“最近剧情”上限从 15 调整为 25 段。
3. 并发写入合并：
   1. 续写成功/失败落盘前先 `getStory` 拉取最新，再合并关键字段写回。
4. 自动恢复：
   1. 进入故事时若 `segments` 为空且存在摘要/summaryHistory，则自动调用 `continueStory` 从摘要恢复（choiceText 固定为“继续推进当前局势”）。

### 35.3 验收标准

1. 长剧情触发摘要压缩后不再出现空白卡死。
2. 退出重进不会回到开头重生成，而是从摘要恢复续写。
3. `pnpm run check` 与 `pnpm test` 通过。

## 36. 上文压缩触发时的上下文硬上限（本轮新增）

### 36.1 目标

1. 修复“首次触发摘要时，摘要尚未生成导致本轮仍发送超长上下文（可达上万字符）”的问题。
2. 保持摘要生成仍为后台并行，不阻塞续写。

### 36.2 实施方案

1. 当检测到 fullHistory 超过阈值且当前 summary 为空时：
   1. 立即后台启动摘要任务（不等待续写结束）。
   2. 本轮续写 history 使用“最近 N 段剧情”硬上限兜底，避免超长请求。
2. 当 summary 已存在时继续使用 `buildHistoryContext(summary + recent)`。

### 36.3 验收标准

1. 上下文超过阈值后，后续请求不再出现 10k+ 的 history 输入。
2. 摘要仍可后台生成并写入 summaryHistory。

## 37. Debug 仪表盘按字符里程碑变色（本轮新增）

### 37.1 目标

1. Debug 仪表盘颜色按发送字符数里程碑判定，超过 8000 按余量进入下一周期。
2. 仍保留“实际发送字符数”的显示，用于定位格式与厂商差异。

### 37.2 实施方案

1. 仪表盘点位/进度条：
   1. 使用发送字符数与阈值 8000 的“周期余量”计算进度（超过 8000 则减去 8000\*n）。
   2. 颜色分级沿用：>=100% 红，>=75% 黄，其余绿。
2. 段落窗口扩展为最多 100 段，并在面板中显示发送段落数。
3. 面板仍保留“实际发送字符数”与“最近发送字符数”。

### 37.3 验收标准

1. 颜色随发送字符里程碑进度变化，超过 8000 后进入下一周期。
2. 面板仍显示实际发送字符数与发送段落数。
3. `pnpm run check` 通过。

## 38. 总结5000节奏与50段窗口校准（本轮新增）

### 38.1 目标

1. 将摘要刷新频率改为每 5000 字新增触发一次。
2. 将上下文窗口从 100 段下调到 50 段，在保证连贯性的同时进一步控长。
3. 仪表盘字符里程碑同步调整为 5000 周期。

### 38.2 实施方案

1. 全局字符阈值：`HISTORY_CONTEXT_CHARS_LIMIT` 从 8000 调整为 5000。
2. 摘要增量阈值：`SUMMARY_REFRESH_DELTA_CHARS = HISTORY_SUMMARY_TRIGGER_CHARS`（即 5000）。
3. `buildHistoryContext` 与 `buildHistoryContextBounded`：
   1. 最近段落窗口改为 50。
   2. bounded 默认 `maxChars` 改为 5000。
4. `updateStory` 与续写发送统一使用 50 段 + 5000 字预算。
5. 仪表盘段落上限改为 50，字符里程碑按 5000 周期计算。

### 38.3 验收标准

1. 摘要每新增约 5000 字触发一次。
2. 发送上下文段落不超过 50，字符不超过 5000。
3. 仪表盘显示与实际发送策略一致。

## 39. 续写超时回调至120秒（本轮新增）

### 39.1 目标

1. 将续写请求超时从 300 秒下调到 120 秒，减少长时间无响应等待。

### 39.2 实施方案

1. 调整 `CONTINUE_REQUEST_TIMEOUT_MS` 为 `120_000`。

### 39.3 验收标准

1. 续写请求在 120 秒时触发超时保护。
2. `pnpm run check` 通过。

## 40. P0：剧情生成长时间卡死修复（本轮新增）

### 40.1 目标

1. 修复“剧情生成超过 5 分钟仍卡在 generating”问题。
2. 覆盖生成主链路中的所有关键 LLM 请求超时，避免任一子调用挂死拖垮流程。
3. 对历史遗留的 generating 存档做超时回收，避免永久转圈。

### 40.2 实施方案

1. LLM 超时防护补全：
   1. 为 `generateStory` 增加 AbortController 超时（120s）。
   2. 为 `summarizeStory` 增加 AbortController 超时（120s）。
   3. 为 `evaluateInitialAffinities` 增加 AbortController 超时（120s）。
   4. 为 `generateSummaryTitle` 增加 AbortController 超时（120s，后台任务）。
2. 生成状态兜底回收：
   1. `loadStory` 检测 `storyGenerationStatus=generating` 且 `updatedAt` 过旧（>3分钟）时，自动回收为 failed。
   2. 只保留最后一次错误信息，提示用户重试。
3. 日志完善：
   1. 记录 timeout 分支，便于定位具体卡死点。

### 40.3 验收标准

1. 任一生成链路单请求超过 120 秒会超时退出，不再无限等待。
2. 历史遗留 generating 存档进入故事后会自动回收为 failed。
3. `pnpm run check` 与 `pnpm test` 通过。
